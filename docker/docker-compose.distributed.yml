# docker-compose.distributed.yml
# Distributed crawler deployment with coordinator and 3 crawler instances
#
# Usage:
#   docker-compose -f docker-compose.yml -f docker-compose.distributed.yml up -d
#
# This extends the base docker-compose.yml with:
#   - Coordinator server for schedule management
#   - 3 crawler instances (Main, Sub1, Sub2)
#   - Each instance with unique IP rotation

version: '3.8'

services:
  # ============================================================================
  # Coordinator Server - Central schedule management
  # ============================================================================
  coordinator:
    build:
      context: ..
      dockerfile: Dockerfile
    container_name: baram-coordinator
    restart: unless-stopped
    # Security: Run as baram user (UID 1001 defined in Dockerfile)
    user: "1001:1001"
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp:mode=1777
    command:
      - "coordinator"
      - "--port"
      - "8080"
      - "--host"
      - "0.0.0.0"
      - "--heartbeat-timeout"
      - "${HEARTBEAT_TIMEOUT:-90}"
      - "--heartbeat-interval"
      - "${HEARTBEAT_INTERVAL:-30}"
      - "--max-instances"
      - "${MAX_INSTANCES:-10}"
    environment:
      RUST_LOG: ${COORDINATOR_LOG_LEVEL:-info}
    ports:
      - "${COORDINATOR_PORT:-8080}:8080"
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/api/health || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      baram-network:
        ipv4_address: 172.28.1.10
    volumes:
      - coordinator_data:/app/data
    labels:
      - "com.baram.role=coordinator"
      - "com.baram.version=${VERSION:-0.1.0}"

  # ============================================================================
  # Crawler Instance - Main (ID: 0)
  # ============================================================================
  crawler-main:
    build:
      context: ..
      dockerfile: Dockerfile
    container_name: baram-crawler-main
    restart: unless-stopped
    # Security: Run as baram user (UID 1001 defined in Dockerfile)
    user: "1001:1001"
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp:mode=1777
    command:
      - "distributed"
      - "--instance"
      - "main"
      - "--coordinator"
      - "http://coordinator:8080"
      - "--database"
      - "postgresql://${POSTGRES_USER:-baram}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-baram}"
      - "--rps"
      - "${REQUESTS_PER_SECOND:-2.0}"
      - "--output"
      - "/app/output"
      - "--heartbeat-interval"
      - "${HEARTBEAT_INTERVAL:-30}"
    environment:
      RUST_LOG: ${CRAWLER_LOG_LEVEL:-info}
      INSTANCE_ID: main
      DATABASE_URL: "postgresql://${POSTGRES_USER:-baram}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-baram}"
      REDIS_URL: "redis://redis:6379"
      OPENSEARCH_URL: "http://opensearch:9200"
      REQUESTS_PER_SECOND: ${REQUESTS_PER_SECOND:-2.0}
      MAX_CONCURRENT_REQUESTS: ${MAX_CONCURRENT:-5}
      ENABLE_DEDUP: "true"
      OUTPUT_DIR: /app/output
      CHECKPOINT_DIR: /app/checkpoints
    depends_on:
      coordinator:
        condition: service_healthy
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      opensearch:
        condition: service_healthy
    healthcheck:
      disable: true
    networks:
      baram-network:
        ipv4_address: 172.28.2.1
    volumes:
      - crawler_main_output:/app/output
      - crawler_main_checkpoints:/app/checkpoints
      - crawler_main_logs:/app/logs
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    labels:
      - "com.baram.role=crawler"
      - "com.baram.instance=main"
      - "com.baram.version=${VERSION:-0.1.0}"

  # ============================================================================
  # Crawler Instance - Sub1 (ID: 1)
  # ============================================================================
  crawler-sub1:
    build:
      context: ..
      dockerfile: Dockerfile
    container_name: baram-crawler-sub1
    restart: unless-stopped
    # Security: Run as baram user (UID 1001 defined in Dockerfile)
    user: "1001:1001"
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp:mode=1777
    command:
      - "distributed"
      - "--instance"
      - "sub1"
      - "--coordinator"
      - "http://coordinator:8080"
      - "--database"
      - "postgresql://${POSTGRES_USER:-baram}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-baram}"
      - "--rps"
      - "${REQUESTS_PER_SECOND:-2.0}"
      - "--output"
      - "/app/output"
      - "--heartbeat-interval"
      - "${HEARTBEAT_INTERVAL:-30}"
    environment:
      RUST_LOG: ${CRAWLER_LOG_LEVEL:-info}
      INSTANCE_ID: sub1
      DATABASE_URL: "postgresql://${POSTGRES_USER:-baram}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-baram}"
      REDIS_URL: "redis://redis:6379"
      OPENSEARCH_URL: "http://opensearch:9200"
      REQUESTS_PER_SECOND: ${REQUESTS_PER_SECOND:-2.0}
      MAX_CONCURRENT_REQUESTS: ${MAX_CONCURRENT:-5}
      ENABLE_DEDUP: "true"
      OUTPUT_DIR: /app/output
      CHECKPOINT_DIR: /app/checkpoints
    depends_on:
      coordinator:
        condition: service_healthy
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      opensearch:
        condition: service_healthy
    healthcheck:
      disable: true
    networks:
      baram-network:
        ipv4_address: 172.28.2.2
    volumes:
      - crawler_sub1_output:/app/output
      - crawler_sub1_checkpoints:/app/checkpoints
      - crawler_sub1_logs:/app/logs
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    labels:
      - "com.baram.role=crawler"
      - "com.baram.instance=sub1"
      - "com.baram.version=${VERSION:-0.1.0}"

  # ============================================================================
  # Crawler Instance - Sub2 (ID: 2)
  # ============================================================================
  crawler-sub2:
    build:
      context: ..
      dockerfile: Dockerfile
    container_name: baram-crawler-sub2
    restart: unless-stopped
    # Security: Run as baram user (UID 1001 defined in Dockerfile)
    user: "1001:1001"
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp:mode=1777
    command:
      - "distributed"
      - "--instance"
      - "sub2"
      - "--coordinator"
      - "http://coordinator:8080"
      - "--database"
      - "postgresql://${POSTGRES_USER:-baram}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-baram}"
      - "--rps"
      - "${REQUESTS_PER_SECOND:-2.0}"
      - "--output"
      - "/app/output"
      - "--heartbeat-interval"
      - "${HEARTBEAT_INTERVAL:-30}"
    environment:
      RUST_LOG: ${CRAWLER_LOG_LEVEL:-info}
      INSTANCE_ID: sub2
      DATABASE_URL: "postgresql://${POSTGRES_USER:-baram}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-baram}"
      REDIS_URL: "redis://redis:6379"
      OPENSEARCH_URL: "http://opensearch:9200"
      REQUESTS_PER_SECOND: ${REQUESTS_PER_SECOND:-2.0}
      MAX_CONCURRENT_REQUESTS: ${MAX_CONCURRENT:-5}
      ENABLE_DEDUP: "true"
      OUTPUT_DIR: /app/output
      CHECKPOINT_DIR: /app/checkpoints
    depends_on:
      coordinator:
        condition: service_healthy
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      opensearch:
        condition: service_healthy
    healthcheck:
      disable: true
    networks:
      baram-network:
        ipv4_address: 172.28.2.3
    volumes:
      - crawler_sub2_output:/app/output
      - crawler_sub2_checkpoints:/app/checkpoints
      - crawler_sub2_logs:/app/logs
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    labels:
      - "com.baram.role=crawler"
      - "com.baram.instance=sub2"
      - "com.baram.version=${VERSION:-0.1.0}"

# ============================================================================
# Additional Volumes
# ============================================================================
volumes:
  coordinator_data:
    driver: local
  crawler_main_output:
    driver: local
  crawler_main_checkpoints:
    driver: local
  crawler_main_logs:
    driver: local
  crawler_sub1_output:
    driver: local
  crawler_sub1_checkpoints:
    driver: local
  crawler_sub1_logs:
    driver: local
  crawler_sub2_output:
    driver: local
  crawler_sub2_checkpoints:
    driver: local
  crawler_sub2_logs:
    driver: local
